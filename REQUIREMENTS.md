# 📋 学习心理诊断工具 - 完整需求文档

## 1. 产品概述

### 1.1 产品名称
**学习心理诊断工具**（Study Mirror）

### 1.2 产品定位
一款"小而美"的 AI 原生学习心理诊断工具。通过 3-5 轮深度对话，利用语义投射技术量化学生学习力背后的四个核心心理维度。

### 1.3 核心价值主张
- **精准诊断**：通过 AI 深度对话，量化学生的心理维度
- **实时反馈**：每轮对话后实时更新心理维度评分
- **个性化方案**：生成学生版和家长版的定制化报告
- **易用易懂**：百分制评分，直观易理解

### 1.4 应用场景
- 学生学习困难诊断
- 心理咨询师辅助工具
- 教育机构学生评估
- AI 大赛演示项目

---

## 2. 技术架构

### 2.1 技术栈
| 层级 | 技术选型 | 版本 | 说明 |
|------|--------|------|------|
| **前端框架** | Streamlit | 1.32+ | 快速迭代，内置组件丰富 |
| **可视化库** | Plotly | 5.18+ | 动态雷达图，支持实时更新 |
| **编程语言** | Python | 3.11+ | 高效开发 |
| **AI 驱动** | 九章/GPT-4o | - | API 调用（待集成） |
| **状态管理** | Streamlit Session State | - | 维护对话历史和维度分值 |

### 2.2 系统架构图
```
┌─────────────────────────────────────────────────────┐
│                   用户浏览器                          │
│              (Streamlit Web UI)                      │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              Streamlit 应用层                        │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │  首页模块    │  │  对话模块    │  │  报告模块  │ │
│  │ (三扇门)     │  │ (左图右谈)   │  │ (待开发)   │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              业务逻辑层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ 场景管理     │  │ 对话管理     │  │ 评分引擎   │ │
│  │ (SCENARIOS)  │  │ (Session)    │  │ (JSON)     │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              数据处理层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌────────────┐ │
│  │ JSON 解析    │  │ 分值验证     │  │ 状态管理   │ │
│  │ (Parser)     │  │ (Validator)  │  │ (State)    │ │
│  └──────────────┘  └──────────────┘  └────────────┘ │
└────────────────────┬────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────┐
│              AI 服务层（待集成）                     │
│  ┌──────────────┐  ┌──────────────┐                 │
│  │ 九章大模型   │  │ GPT-4o       │                 │
│  │ API          │  │ API          │                 │
│  └──────────────┘  └──────────────┘                 │
└─────────────────────────────────────────────────────┘
```

---

## 3. 功能需求

### 3.1 首页 - 三扇门场景入口

#### 3.1.1 页面布局
- **页面宽度**：占屏幕宽度的 80%，居中显示
- **背景**：渐变背景（#f5f7fa → #c3cfe2）
- **标题**：
  - 主标题：🧠 学习心理诊断工具
  - 副标题：通过深度对话，发现你的学习心理密码

#### 3.1.2 三扇门卡片设计

**卡片 1：失意之径**
- **图标**：😔
- **标题**：失意之径
- **描述**：努力后却考砸了
- **System Prompt**：
  ```
  你是一位温暖、专业的心理咨询师。学生刚经历了一次考试失利，尽管他们付出了努力。
  你的任务是通过深度对话，理解他们的心理状态，并评估以下四个维度：
  1. 归因风格：他们如何解释失败（内部/外部、稳定/不稳定、全局/特定）
  2. 自我效能感：他们对自己能力的信心程度
  3. 认知负荷：当前的心理压力和信息处理能力
  4. 元认知：他们对自己学习过程的认知和反思能力
  请用温暖、鼓励的语气进行对话，每次回复都要包含一个澄清式追问。
  ```

**卡片 2：深谷挑战**
- **图标**：🌙
- **标题**：深谷挑战
- **描述**：深夜遇难题卡住
- **System Prompt**：
  ```
  你是一位温暖、专业的心理咨询师。学生在深夜做题时遇到了难题，感到困顿和无力。
  你的任务是通过深度对话，理解他们的心理状态，并评估以下四个维度：
  1. 归因风格：他们如何看待这个难题（能力问题还是方法问题）
  2. 自我效能感：他们对解决问题的信心
  3. 认知负荷：深夜疲劳状态下的心理压力
  4. 元认知：他们的学习策略和自我调节能力
  请用温暖、鼓励的语气进行对话，帮助他们重新获得信心。
  ```

**卡片 3：意志荒漠**
- **图标**：📱
- **标题**：意志荒漠
- **描述**：想放弃去刷视频
- **System Prompt**：
  ```
  你是一位温暖、专业的心理咨询师。学生感到学习疲惫，想要放弃学习去刷视频。
  你的任务是通过深度对话，理解他们的心理状态，并评估以下四个维度：
  1. 归因风格：他们如何看待学习的意义和价值
  2. 自我效能感：他们对自己坚持能力的信心
  3. 认知负荷：当前的心理压力和疲劳程度
  4. 元认知：他们对自己学习动力的认知
  请用温暖、鼓励的语气进行对话，帮助他们找到学习的内在动力。
  ```

#### 3.1.3 卡片样式
- **背景**：白色
- **圆角**：16px
- **内边距**：24px
- **阴影**：`0 4px 12px rgba(0,0,0,0.1)`
- **Hover 效果**：
  - 向上浮起 4px
  - 阴影加强：`0 8px 20px rgba(0,0,0,0.15)`
  - 过渡时间：0.3s

#### 3.1.4 交互逻辑
- 点击任意卡片，初始化对应的场景 System Prompt
- 进入对话界面
- 清空之前的对话历史
- 重置对话轮数为 0

---

### 3.2 对话页面 - 左图右谈

#### 3.2.1 页面布局

**顶部导航栏**（三列布局）
- **左列**：← 返回首页 按钮
- **中列**：🧠 场景标题（居中）
- **右列**：进度显示（紫蓝色字体）
  - 格式：`进度: X/4 轮`

**主体内容**（两列布局，比例 1:1.2）
- **左侧**（45%）：心理维度仪表盘
- **右侧**（55%）：深度对话

#### 3.2.2 左侧 - 心理维度仪表盘

##### 3.2.2.1 动态雷达图

**图表类型**：Plotly Scatterpolar（极坐标散点图）

**四个维度**：
1. 归因风格
2. 自我效能感
3. 认知负荷
4. 元认知

**分值范围**：0-100（百分制）

**默认分值**：50 分

**图表样式**：
- **填充颜色**：`rgba(102, 126, 234, 0.3)`（半透明紫蓝色）
- **线条颜色**：`rgba(102, 126, 234, 0.8)`（紫蓝色）
- **线条宽度**：2.5px
- **标记点颜色**：#667eea（紫蓝色）
- **标记点大小**：8px
- **Y 轴范围**：0-100
- **Y 轴标签后缀**：" 分"
- **高度**：380px
- **背景**：`rgba(240, 240, 240, 0.5)`

**更新机制**：
- 每轮对话后，根据 AI 返回的 scores 实时更新
- 平滑过渡（Plotly 自动处理）

##### 3.2.2.2 语义透视窗

**位置**：雷达图下方

**样式**：
- **背景**：`linear-gradient(135deg, #fff9e6 0%, #fffde7 100%)`（黄色渐变）
- **边框**：1px solid `rgba(251, 192, 45, 0.2)` + 左边框 4px solid #fbc02d
- **圆角**：8px
- **内边距**：12px 14px
- **阴影**：`0 2px 6px rgba(251, 192, 45, 0.1)`
- **字体大小**：13px
- **字体颜色**：#555
- **字体加粗**：500

**内容格式**：
```
🔍 捕捉到：[关键词1]、[关键词2]、[关键词3]
```

**示例**：
```
🔍 捕捉到：能力内化归因、自我反思能力、恢复性思维
```

**更新机制**：
- 每轮对话后，根据 AI 返回的 analysis_log 更新
- 显示 AI 捕捉的心理学关键概念

##### 3.2.2.3 维度分值卡片

**位置**：语义透视窗下方

**布局**：两行两列
- 第一行：归因风格、自我效能感
- 第二行：认知负荷、元认知

**卡片样式**：
- **背景**：`linear-gradient(135deg, #667eea 0%, #764ba2 100%)`（紫蓝色渐变）
- **圆角**：12px
- **内边距**：16px 12px
- **边框**：1px solid `rgba(255, 255, 255, 0.2)`
- **阴影**：`0 4px 12px rgba(102, 126, 234, 0.3)`
- **文字颜色**：白色
- **文字对齐**：居中

**Hover 效果**：
- 向上浮起 2px
- 阴影加强：`0 6px 16px rgba(102, 126, 234, 0.4)`
- 过渡时间：0.3s

**卡片内容**：
```
┌─────────────────┐
│  维度名称       │  (font-size: 12px, opacity: 0.95)
│  分值           │  (font-size: 24px, font-weight: bold)
└─────────────────┘
```

**示例**：
```
┌─────────────────┐
│  归因风格       │
│  58             │
└─────────────────┘
```

**更新机制**：
- 每轮对话后，根据 AI 返回的 scores 实时更新
- 显示整数分值（0-100）

#### 3.2.3 右侧 - 深度对话

##### 3.2.3.1 对话历史容器

**样式**：
- **背景**：白色
- **圆角**：12px
- **内边距**：16px
- **边框**：1px solid #e0e0e0
- **最大高度**：400px
- **超出处理**：自动滚动（overflow-y: auto）

##### 3.2.3.2 AI 气泡

**样式**：
- **背景**：`linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)`（蓝紫色渐变）
- **圆角**：16px
- **内边距**：14px 18px
- **外边距**：10px 0
- **边框**：1px solid `rgba(63, 81, 181, 0.2)`
- **阴影**：`0 2px 8px rgba(63, 81, 181, 0.1)`
- **字体大小**：14px
- **行高**：1.6
- **文字颜色**：#333

**标签样式**：
- **标签**：🧠 心理咨询师：
- **标签颜色**：#3f51b5
- **标签加粗**：600

##### 3.2.3.3 用户气泡

**样式**：
- **背景**：`linear-gradient(135deg, #c8e6c9 0%, #e8f5e9 100%)`（绿色渐变）
- **圆角**：16px
- **内边距**：14px 18px
- **外边距**：10px 0
- **边框**：1px solid `rgba(76, 175, 80, 0.2)`
- **阴影**：`0 2px 8px rgba(76, 175, 80, 0.1)`
- **字体大小**：14px
- **行高**：1.6
- **文字颜色**：#333

**标签样式**：
- **标签**：👤 你：
- **标签颜色**：#4caf50
- **标签加粗**：600

##### 3.2.3.4 用户输入框

**样式**：
- **圆角**：12px
- **边框**：2px solid #e0e0e0
- **内边距**：12px 14px
- **字体大小**：14px
- **高度**：90px
- **过渡时间**：0.3s

**Focus 效果**：
- **边框颜色**：#667eea（紫蓝色）
- **阴影**：`0 0 0 3px rgba(102, 126, 234, 0.1)`

**占位符文本**：
```
请详细描述你的想法和感受...
```

##### 3.2.3.5 操作按钮

**按钮 1：提交回答**
- **图标**：📤
- **文本**：提交回答
- **宽度比例**：1.2
- **样式**：
  - 圆角：10px
  - 字体加粗：600
  - 内边距：10px 20px
  - 过渡时间：0.3s

**Hover 效果**：
- 向上浮起 2px
- 阴影加强：`0 4px 12px rgba(0, 0, 0, 0.15)`

**按钮 2：返回**
- **图标**：🏠
- **文本**：返回
- **宽度比例**：1
- **样式**：同上

##### 3.2.3.6 生成报告按钮

**触发条件**：
- 对话轮数 >= 4 轮
- 或 AI 返回 is_finished: true

**按钮样式**：
- **图标**：📋
- **文本**：生成深度透视报告
- **类型**：primary（主按钮）
- **宽度**：100%
- **样式**：同操作按钮

#### 3.2.4 交互逻辑

##### 3.2.4.1 用户输入处理

**步骤 1：字数检测**
```
if len(user_input.strip()) < 5:
    显示提示：💡 你的回答有点简短，能否详细一些呢？
    不进行打分
    不调用 AI
else:
    继续步骤 2
```

**步骤 2：添加用户消息**
```
dialogue_history.append({
    "role": "user",
    "content": user_input
})
```

**步骤 3：调用 AI**
```
ai_response = call_ai_api(
    user_input=user_input,
    scenario=current_scenario,
    round_num=round_count + 1
)
```

**步骤 4：解析 AI 响应**
```
dialogue, scores, is_finished, semantic_log = parse_ai_response(ai_response)
```

**步骤 5：更新状态**
```
dialogue_history.append({
    "role": "assistant",
    "content": dialogue
})
current_scores = scores
scores_history.append(scores)
semantic_log = semantic_log
round_count += 1
```

**步骤 6：重新渲染**
```
st.rerun()
```

##### 3.2.4.2 返回首页
- 点击"← 返回首页"或"🏠 返回"按钮
- 清空对话历史
- 重置分值为默认值（50 分）
- 重置对话轮数为 0
- 返回首页

---

## 4. 数据协议

### 4.1 AI 返回 JSON 格式

**必须返回的 JSON 结构**：

```json
{
  "dialogue": "AI 对学生的回复文字",
  "scores": {
    "归因风格": 50,
    "自我效能感": 55,
    "认知负荷": 45,
    "元认知": 60
  },
  "is_finished": false,
  "analysis_log": "捕捉到：能力内化归因、自我反思能力"
}
```

### 4.2 字段说明

| 字段 | 类型 | 范围 | 必需 | 说明 |
|------|------|------|------|------|
| dialogue | string | - | ✅ | AI 的回复文本，长度 50-500 字 |
| scores | object | - | ✅ | 四个维度的评分 |
| scores.归因风格 | number | 0-100 | ✅ | 整数分值 |
| scores.自我效能感 | number | 0-100 | ✅ | 整数分值 |
| scores.认知负荷 | number | 0-100 | ✅ | 整数分值 |
| scores.元认知 | number | 0-100 | ✅ | 整数分值 |
| is_finished | boolean | - | ❌ | 是否完成诊断，默认 false |
| analysis_log | string | - | ❌ | 心理学分析日志，显示捕捉的关键词 |

### 4.3 JSON 验证规则

```python
def validate_ai_response(response: Dict) -> bool:
    # 1. 检查必需字段
    if "dialogue" not in response or "scores" not in response:
        return False

    # 2. 检查 dialogue 类型和长度
    if not isinstance(response["dialogue"], str):
        return False
    if len(response["dialogue"]) < 10:
        return False

    # 3. 检查 scores 结构
    required_dimensions = ["归因风格", "自我效能感", "认知负荷", "元认知"]
    if not all(dim in response["scores"] for dim in required_dimensions):
        return False

    # 4. 检查分值范围
    for dim, score in response["scores"].items():
        if not isinstance(score, (int, float)):
            return False
        if not (0 <= score <= 100):
            return False

    return True
```

---

## 5. 状态管理

### 5.1 Session State 结构

```python
st.session_state = {
    "page": "home",  # 当前页面：home, dialogue, report
    "scenario": None,  # 当前场景：失意之径, 深谷挑战, 意志荒漠
    "dialogue_history": [],  # 对话历史
    "current_scores": {  # 当前分值
        "归因风格": 50,
        "自我效能感": 50,
        "认知负荷": 50,
        "元认知": 50
    },
    "scores_history": [],  # 分值历史
    "round_count": 0,  # 对话轮数
    "semantic_log": ""  # 语义透视日志
}
```

### 5.2 对话历史结构

```python
dialogue_history = [
    {
        "role": "user",
        "content": "用户输入的文本"
    },
    {
        "role": "assistant",
        "content": "AI 返回的对话文本"
    },
    ...
]
```

---

## 6. 样式设计

### 6.1 颜色系统

| 用途 | 颜色 | 十六进制 | RGB |
|------|------|---------|-----|
| 主色 | 紫蓝色 | #667eea | rgb(102, 126, 234) |
| 辅色 1 | 紫色 | #764ba2 | rgb(118, 75, 162) |
| AI 气泡 | 蓝紫色渐变 | #e3f2fd → #f3e5f5 | - |
| 用户气泡 | 绿色渐变 | #c8e6c9 → #e8f5e9 | - |
| 语义窗 | 黄色渐变 | #fff9e6 → #fffde7 | - |
| 背景 | 浅蓝渐变 | #f5f7fa → #c3cfe2 | - |
| 文字 | 深灰色 | #333 | rgb(51, 51, 51) |

### 6.2 间距系统

| 用途 | 大小 |
|------|------|
| 卡片内边距 | 24px |
| 对话气泡内边距 | 14px 18px |
| 对话气泡外边距 | 10px 0 |
| 对话容器内边距 | 16px |
| 分值卡片内边距 | 16px 12px |
| 语义窗内边距 | 12px 14px |

### 6.3 圆角系统

| 用途 | 大小 |
|------|------|
| 卡片 | 16px |
| 对话气泡 | 16px |
| 对话容器 | 12px |
| 分值卡片 | 12px |
| 语义窗 | 8px |
| 输入框 | 12px |
| 按钮 | 10px |

### 6.4 阴影系统

| 用途 | 阴影 |
|------|------|
| 卡片 | `0 4px 12px rgba(0,0,0,0.1)` |
| 卡片 Hover | `0 8px 20px rgba(0,0,0,0.15)` |
| AI 气泡 | `0 2px 8px rgba(63, 81, 181, 0.1)` |
| 用户气泡 | `0 2px 8px rgba(76, 175, 80, 0.1)` |
| 分值卡片 | `0 4px 12px rgba(102, 126, 234, 0.3)` |
| 分值卡片 Hover | `0 6px 16px rgba(102, 126, 234, 0.4)` |
| 语义窗 | `0 2px 6px rgba(251, 192, 45, 0.1)` |

---

## 7. 开发路线图

### Phase 1 - 基础框架（✅ 已完成）
- [x] 项目初始化
- [x] 首页三扇门设计
- [x] 对话页面左图右谈布局
- [x] 动态雷达图实现
- [x] 对话管理系统
- [x] JSON 解析器
- [x] UI/UX 优化

### Phase 2 - AI 集成（⏳ 待开发）
- [ ] 集成九章大模型 API
- [ ] 集成 GPT-4o API
- [ ] 完善 System Prompt
- [ ] 实现流式输出
- [ ] 错误重试机制

### Phase 3 - 报告生成（⏳ 待开发）
- [ ] 深度透视报告生成
- [ ] 学生版报告（心理动力分析 + 行动处方）
- [ ] 家长版报告（非暴力沟通话术）
- [ ] 报告导出功能（PDF/Word）

### Phase 4 - 数据持久化（⏳ 待开发）
- [ ] 用户认证系统
- [ ] 数据库集成
- [ ] 对话历史存储
- [ ] 数据分析仪表板

---

## 8. 性能指标

| 指标 | 目标 | 优先级 |
|------|------|--------|
| 首屏加载时间 | < 2s | 高 |
| 对话响应时间 | < 3s | 高 |
| 页面占屏幕宽度 | 80% | 中 |
| 评分系统精度 | 0-100 | 高 |
| 对话轮数 | 3-5 轮 | 中 |
| 代码行数 | < 1000 | 低 |

---

## 9. 测试用例

### 9.1 首页测试

| 用例 | 步骤 | 预期结果 |
|------|------|---------|
| 首页加载 | 打开应用 | 显示三扇门卡片 |
| 卡片 Hover | 鼠标悬停卡片 | 卡片向上浮起，阴影加强 |
| 进入场景 1 | 点击"失意之径" | 进入对话页面，显示对应场景 |
| 进入场景 2 | 点击"深谷挑战" | 进入对话页面，显示对应场景 |
| 进入场景 3 | 点击"意志荒漠" | 进入对话页面，显示对应场景 |

### 9.2 对话页面测试

| 用例 | 步骤 | 预期结果 |
|------|------|---------|
| 输入过短 | 输入 < 5 字 | 显示提示，不调用 AI |
| 输入正常 | 输入 >= 5 字 | 调用 AI，显示回复 |
| 分值更新 | 完成一轮对话 | 雷达图和分值卡片更新 |
| 对话轮数 | 完成一轮对话 | 进度显示更新 |
| 返回首页 | 点击返回按钮 | 返回首页，清空对话 |
| 生成报告 | 4 轮对话后 | 显示生成报告按钮 |

---

## 10. 部署要求

### 10.1 环境要求
- Python 3.11+
- Streamlit 1.32+
- Plotly 5.18+

### 10.2 依赖包
```
streamlit>=1.32.0
plotly>=5.18.0
python-dotenv>=1.0.0
protobuf>=4.25.0
```

### 10.3 运行命令
```bash
streamlit run app.py
```

### 10.4 访问地址
```
http://localhost:8501
```

---

## 11. 注意事项

### 11.1 用户体验
- 所有交互都应该有明确的视觉反馈
- 加载时间不应超过 3 秒
- 错误信息应该清晰易懂

### 11.2 数据安全
- 所有数据仅在当前会话中保存
- 不涉及用户隐私信息存储
- 对话内容不会被持久化

### 11.3 可访问性
- 支持键盘导航
- 颜色对比度满足 WCAG 标准
- 字体大小清晰易读

---

## 12. 参考资源

### 12.1 心理学理论
- **归因风格**：Weiner 的归因理论
- **自我效能感**：Bandura 的自我效能感理论
- **认知负荷**：Sweller 的认知负荷理论
- **元认知**：Flavell 的元认知理论

### 12.2 技术文档
- [Streamlit 官方文档](https://docs.streamlit.io)
- [Plotly 官方文档](https://plotly.com/python)
- [Python 官方文档](https://docs.python.org)

---

## 附录 A：完整的 JSON 示例

### 示例 1：失意之径 - 第一轮对话

**用户输入**：
```
我最近参加了一次重要的考试，虽然我花了很多时间复习，但最后的成绩还是不理想。
我感到很失望，不知道是不是我的学习方法有问题。
```

**AI 返回**：
```json
{
  "dialogue": "我能感受到你现在的失落。考试没有达到预期，这确实让人难受。我注意到你提到了'花了很多时间复习'，这说明你很努力。那么，你觉得这次失利主要是因为什么呢？是知识掌握不够，还是考试时的状态问题，或者是其他原因？",
  "scores": {
    "归因风格": 48,
    "自我效能感": 45,
    "认知负荷": 62,
    "元认知": 52
  },
  "is_finished": false,
  "analysis_log": "捕捉到：努力投入、自我怀疑、归因探索"
}
```

### 示例 2：深谷挑战 - 第二轮对话

**用户输入**：
```
我在做一道数学题时卡住了，已经想了半个小时还是没有思路。
我感到很沮丧，甚至想放弃这道题。
```

**AI 返回**：
```json
{
  "dialogue": "半小时的思考说明你在认真对待这个问题。卡住是很正常的，这不代表你不行。让我问你一个问题：当你遇到这样的难题时，你通常会怎么处理？是继续思考，还是查看相关资料，或者寻求帮助？",
  "scores": {
    "归因风格": 52,
    "自我效能感": 48,
    "认知负荷": 68,
    "元认知": 55
  },
  "is_finished": false,
  "analysis_log": "捕捉到：问题解决策略、坚持力评估、疲劳管理"
}
```

---

**文档版本**：1.0
**最后更新**：2025-12-23
**作者**：AI 产品团队

